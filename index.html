<html>
<head>
	<title>LiquorInfo</title>
	
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	
  <link rel="stylesheet" href="style.css" type="text/css">
  	
</head>
<body>
  
  <div class="noPrint">
  <h3>Enter an address to gather relevant info for assessing a liquor license in Brooklyn, NY.</h3>
  <p>The Liquor License Helper produces a printable summary report for use by Brooklyn Community Boards in liquor licensing discussions. For any given address, the helper finds details of churches within ~200ft and licensed properties within ~500ft.</p>
  <form action="#" id="get-address">
 <input type="text" name="addressQuery" id="addressQuery" value="332 ROGERS AVENUE">
  <input type="submit" value="Search">
  </form>

<hr>
</div>

<div class="results dynamic"></div>
<div class="sources dynamic"></div>

<script>

$('#get-address').submit(function() {
  
  // important info to hang onto
  var address, cartodb_id, the_geom;
  
  // distances
  var churchDist, liquorDist;
  
  // construct our string to lookup
  var addressQuery = $("input").val();
  var addressBase = "https://pluto.cartodb.com/api/v2/sql?q=SELECT address, cartodb_id, the_geom FROM bk_mappluto_13v1 where address = upper(";
  var addressString = addressBase + "'" + addressQuery + "');" ;
    
  $(".dynamic").empty();
  
  console.log("Searching for " + addressQuery);
  
  $.getJSON(addressString, function(data) {
    
    if (data.rows.length > 0) {
      address = data.rows[0].address;
      cartodb_id = data.rows[0].cartodb_id;
      the_geom = data.rows[0].the_geom;
      
      console.log("Found " + addressQuery + ", looking for nearby properties");
      
      $( ".results" ).append( "<h2>Churches and bars near to " + addressQuery + "</h2><p><small>Report generated with Liquor License Helper for NYC Community Boards, fkh.github.io/liquorinfo. Use with caution, refer to source info in footer.</small></p>" );
      
      // query for all parcels within 100m, a very generous approximation of 200ft (building entrances, etc)
      var allNearby = "https://pluto.cartodb.com/api/v2/sql?q=SELECT initcap(address) as address, BldgClass, initcap(OwnerName) as ownername from bk_mappluto_13v1  where ST_DWithin(geography(the_geom), geography('" + the_geom + "'), 100);";

      // get it...
      $.getJSON(allNearby, function(places) {
        
        console.log("Found " + places.rows.length + " tax parcels nearby.");
        
        var churches = $(places.rows).filter(function(){
              return this.bldgclass.charAt(0) == "M";
          });
          
          if(churches.length > 0){
            
            $( ".results" ).append( "<p><span class='number'>" + churches.length + "</span> places of worship nearby.</p>" );
            
            $( ".results" ).append( "<ul>" );
            
            $.each( churches, function( index, value ){
              $( ".results" ).append( "<li>" + value.address + " - " + value.ownername + "</li>");                
            });

            $( ".results" ).append( "</ul>" );
            
          } else {
            
            $( ".results" ).append( "<p><span class='number'>0</span> places of worship nearby.</p>" );
            
          }
          
          //do something with church locations, like print addresses
          
          
        
      });
      
      // now look at liquor licenses
      
      //query string for liquor licenses
      
      var liquorNearby = "https://fkh.cartodb.com/api/v2/sql?q=SELECT initcap(address) as address, initcap(premises) as premises, initcap(dba) as dba from sla where ST_DWithin(geography(the_geom), geography('" + the_geom + "'), 100);";      
      
      // get the liquor licenses
      
      $.getJSON(liquorNearby, function(licenses) {
        
        console.log("Found " + licenses.rows.length + " liquor licenses nearby.");
        
        if (licenses.rows.length > 0 ) {
          
          var establishments = licenses.rows;
          
          console.log(establishments);
          
          $( ".results" ).append( "<p><span class='number'>" + licenses.rows.length + "</span> establishments with liquor licenses nearby.</p>" );        
        
          $( ".results" ).append( "<ul>" );

          $.each( establishments, function( index, value ){
            if (value.dba == "") {
            $( ".results" ).append( "<li>" + value.address + " - <strong>" + value.premises + "</strong></li>"); 
            } else {
              $( ".results" ).append( "<li>" + value.address + " - " + value.premises + " dba <strong>" + value.dba + "</strong></li>");               
            }               
          });
          
          $( ".results" ).append( "</ul>" );
          
        } else {
          
          $( ".results" ).append( "<p><span class='number'>0</span> licensed establishments nearby.</p>" );
          
        }
        
      });
      
      
      // finally, attach sources:
      
      var timestamp = new Date();
      
      sources = "<hr><p>Data sources: Report generated using PLUTO data from NYC DCP and the List of Active Licenses from NYS Liquor Authority. Generated " + timestamp + ".</p>";
      
      sources += "<p><strong>PLUTO</strong> version 13 v1, accessed via CartoDB at <a href='https://github.com/CartoDB/cartodb-pluto'>github.com/CartoDB/cartodb-pluto</a>. DCP's disclaimer: <em>PLUTO is being provided by the Department of City Planning (DCP) on DCP's website for informational purposes only. DCP does not warranty the completeness, accuracy, content, or fitness for any particular purpose or use of PLUTO, nor are any such warranties to be implied or inferred with respect to PLUTO as furnished on the website.</em></p>";
      
      sources += "<p><strong>List of Active Licenses</strong> dated 5/10/2013. Retrieved from <a href='https://data.ny.gov/Economic-Development/Liquor-Authority-Quarterly-List-of-Active-Licenses/wg8y-fzsj'>data.ny.gov</a>. State Liquor Authority disclaimer: <em>This dataset includes the active licenses in NYS and is updated quarterly. More detailed information regarding newly issued licenses can be obtained from through our Public Query section of the SLA website, www.sla.ny.gov or through the Freedom of Information Law (FOIL) process.</em></p>";
      
      sources += "<p>Alpha, proof of concept. Likely only works in Chrome. <a href='https://github.com/fkh/liquorinfo/issues'>Got feedback?</a> Data searching powered by CartoDB, bad Javascript by <a href='https://twitter.com/fkh'>@fkh</a>. Check out <a href='https://github.com/fkh/liquorinfo'>the source on GitHub</a>.</p><p>.</p>";
      
      $( ".sources" ).append( sources );
      
            
    } else {
      console.log("Address not found.");
      
      $( ".results" ).append( "<p>Address not found.</p>" );
      
    }


  });
  return false;
});

</script>

</body>
</html>
